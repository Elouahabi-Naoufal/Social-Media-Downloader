{% extends "base.html" %}

{% block title %}{{ blog.title }} - Social Media Downloader{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Back Link -->
    <div class="mb-8">
        <a href="{{ url_for('blog_list') }}" class="inline-flex items-center text-blue-600 hover:text-blue-800">
            <i class="fas fa-arrow-left mr-2"></i>Back to Blog
        </a>
    </div>

    <!-- Article -->
    <article class="bg-white rounded-2xl shadow-lg p-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center text-sm text-gray-500 mb-4">
                <time>{{ blog.created_at.strftime('%B %d, %Y') }}</time>
                {% if blog.updated_at != blog.created_at %}
                <span class="mx-2">•</span>
                <span>Updated {{ blog.updated_at.strftime('%B %d, %Y') }}</span>
                {% endif %}
            </div>
            
            <h1 class="text-4xl font-bold text-gray-800 leading-tight">{{ blog.title }}</h1>
        </header>

        <!-- Content -->
        <div class="prose prose-lg max-w-none markdown-content" id="blogContent">
            <div style="display: none;">{{ blog.content }}</div>
        </div>
    </article>

    <!-- Navigation -->
    <div class="mt-12 text-center">
        <a href="{{ url_for('blog_list') }}" 
           class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-8 py-3 rounded-2xl font-bold hover:from-blue-600 hover:to-cyan-600 transition-all duration-300 hover:scale-105 shadow-lg">
            <i class="fas fa-list mr-2"></i>View All Posts
        </a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function renderMarkdown(text) {
    let html = text;
    
    // Escape HTML first
    html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // Headers (must be first)
    html = html.replace(/^#{6}\s+(.+)$/gm, '<h6 class="text-sm font-bold mt-6 mb-3 text-gray-700">$1</h6>');
    html = html.replace(/^#{5}\s+(.+)$/gm, '<h5 class="text-base font-bold mt-6 mb-3 text-gray-800">$1</h5>');
    html = html.replace(/^#{4}\s+(.+)$/gm, '<h4 class="text-lg font-bold mt-6 mb-3 text-gray-800">$1</h4>');
    html = html.replace(/^#{3}\s+(.+)$/gm, '<h3 class="text-xl font-bold mt-8 mb-4 text-gray-900">$1</h3>');
    html = html.replace(/^#{2}\s+(.+)$/gm, '<h2 class="text-2xl font-bold mt-8 mb-4 text-gray-900">$1</h2>');
    html = html.replace(/^#{1}\s+(.+)$/gm, '<h1 class="text-3xl font-bold mt-8 mb-6 text-gray-900">$1</h1>');
    
    // Horizontal rules
    html = html.replace(/^---+$/gm, '<hr class="my-8 border-t-2 border-gray-300">');
    html = html.replace(/^\*\*\*+$/gm, '<hr class="my-8 border-t-2 border-gray-300">');
    
    // Code blocks (before inline code)
    html = html.replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-900 text-green-400 p-4 rounded-lg my-4 overflow-x-auto"><code>$1</code></pre>');
    
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code class="bg-gray-100 text-red-600 px-2 py-1 rounded text-sm font-mono">$1</code>');
    
    // Bold and italic (order matters)
    html = html.replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>');
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-bold">$1</strong>');
    html = html.replace(/\*([^*]+)\*/g, '<em class="italic">$1</em>');
    
    // Strikethrough
    html = html.replace(/~~([^~]+)~~/g, '<del class="line-through text-gray-500">$1</del>');
    
    // Links (before images)
    html = html.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" class="text-blue-600 hover:text-blue-800 underline font-medium" target="_blank">$1</a>');
    
    // Images
    html = html.replace(/!\[([^\]]*)\]\(([^\)]+)\)/g, '<img src="$2" alt="$1" class="max-w-full h-auto rounded-lg shadow-lg my-4 block" style="max-height: 600px; width: auto;" loading="lazy">');
    
    // Tables
    const lines = html.split('\n');
    let inTable = false;
    let tableRows = [];
    let processedLines = [];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (line.includes('|') && line.split('|').length > 2) {
            if (!inTable) {
                inTable = true;
                tableRows = [];
            }
            
            const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell !== '');
            if (cells.length > 0) {
                const isHeader = i + 1 < lines.length && lines[i + 1].includes('---');
                const cellTag = isHeader ? 'th' : 'td';
                const cellClass = isHeader ? 'bg-gray-50 font-bold text-gray-900 px-4 py-3 border border-gray-300' : 'px-4 py-3 border border-gray-300';
                const cellsHtml = cells.map(cell => `<${cellTag} class="${cellClass}">${cell}</${cellTag}>`).join('');
                tableRows.push(`<tr class="${isHeader ? '' : 'hover:bg-gray-50'}">${cellsHtml}</tr>`);
            }
        } else if (line.includes('---') && inTable) {
            // Skip separator line
            continue;
        } else {
            if (inTable) {
                processedLines.push(`<table class="w-full border-collapse border border-gray-300 my-6 bg-white rounded-lg overflow-hidden shadow-sm">${tableRows.join('')}</table>`);
                tableRows = [];
                inTable = false;
            }
            processedLines.push(line);
        }
    }
    
    if (inTable && tableRows.length > 0) {
        processedLines.push(`<table class="w-full border-collapse border border-gray-300 my-6 bg-white rounded-lg overflow-hidden shadow-sm">${tableRows.join('')}</table>`);
    }
    
    html = processedLines.join('\n');
    
    // Lists
    html = html.replace(/^\s*[-*+]\s+(.+)$/gm, '<li class="ml-6 mb-1">• $1</li>');
    html = html.replace(/^\s*(\d+)\.\s+(.+)$/gm, '<li class="ml-6 mb-1">$1. $2</li>');
    
    // Wrap consecutive list items
    html = html.replace(/((<li[^>]*>.*?<\/li>\s*)+)/g, '<ul class="my-4 space-y-1">$1</ul>');
    
    // Blockquotes
    html = html.replace(/^>\s+(.+)$/gm, '<blockquote class="border-l-4 border-blue-500 pl-4 py-2 my-4 bg-blue-50 italic text-gray-700">$1</blockquote>');
    
    // Line breaks and paragraphs
    html = html.replace(/\n\n+/g, '</p><p class="mb-4">');
    html = html.replace(/\n/g, '<br>');
    html = '<p class="mb-4">' + html + '</p>';
    
    // Clean up empty paragraphs
    html = html.replace(/<p[^>]*><\/p>/g, '');
    html = html.replace(/<p[^>]*>\s*<\/p>/g, '');
    
    return html;
}

document.addEventListener('DOMContentLoaded', function() {
    const content = document.getElementById('blogContent');
    const hiddenDiv = content.querySelector('div[style*="display: none"]');
    const rawContent = hiddenDiv ? hiddenDiv.textContent : content.textContent;
    
    let html = rawContent;
    
    // Convert markdown images to HTML images (keep unchanged)
    html = html.replace(/!\[([^\]]*)\]\(([^\)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto; max-height: 600px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 16px auto; display: block;" loading="lazy">');
    
    // Convert headers (all bold by default)
    html = html.replace(/^#{6}\s+(.+)$/gm, '<h6 class="text-sm font-bold mt-4 mb-2">$1</h6>');
    html = html.replace(/^#{5}\s+(.+)$/gm, '<h5 class="text-base font-bold mt-4 mb-2">$1</h5>');
    html = html.replace(/^#{4}\s+(.+)$/gm, '<h4 class="text-lg font-bold mt-6 mb-3">$1</h4>');
    html = html.replace(/^#{3}\s+(.+)$/gm, '<h3 class="text-xl font-bold mt-6 mb-3">$1</h3>');
    html = html.replace(/^#{2}\s+(.+)$/gm, '<h2 class="text-2xl font-bold mt-8 mb-4">$1</h2>');
    html = html.replace(/^#{1}\s+(.+)$/gm, '<h1 class="text-3xl font-bold mt-8 mb-6">$1</h1>');
    
    // Convert horizontal rules
    html = html.replace(/^---+$/gm, '<hr class="my-8 border-t-2 border-gray-300">');
    html = html.replace(/\n---\n/g, '<hr class="my-8 border-t-2 border-gray-300">');
    html = html.replace(/---/g, '<hr class="my-8 border-t-2 border-gray-300">');
    
    // Convert tables
    const lines = html.split('\n');
    let processedLines = [];
    let inTable = false;
    let tableRows = [];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (line.includes('|') && line.split('|').length > 2) {
            if (!inTable) {
                inTable = true;
                tableRows = [];
            }
            
            if (!line.includes('---')) {
                const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell !== '');
                if (cells.length > 0) {
                    const isHeader = i + 1 < lines.length && lines[i + 1].includes('---');
                    const cellTag = isHeader ? 'th' : 'td';
                    const cellClass = isHeader ? 'bg-gray-50 font-bold px-4 py-3 border border-gray-300' : 'px-4 py-3 border border-gray-300';
                    const cellsHtml = cells.map(cell => `<${cellTag} class="${cellClass}">${cell}</${cellTag}>`).join('');
                    tableRows.push(`<tr>${cellsHtml}</tr>`);
                }
            }
        } else {
            if (inTable && tableRows.length > 0) {
                processedLines.push(`<table class="w-full border-collapse border border-gray-300 my-6 bg-white rounded-lg overflow-hidden shadow-sm">${tableRows.join('')}</table>`);
                tableRows = [];
                inTable = false;
            }
            if (!line.includes('---') || !inTable) {
                processedLines.push(line);
            }
        }
    }
    
    if (inTable && tableRows.length > 0) {
        processedLines.push(`<table class="w-full border-collapse border border-gray-300 my-6 bg-white rounded-lg overflow-hidden shadow-sm">${tableRows.join('')}</table>`);
    }
    
    html = processedLines.join('\n');
    
    // Convert bold/italic
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-bold">$1</strong>');
    html = html.replace(/\*([^*]+)\*/g, '<em class="italic">$1</em>');
    
    // Convert code
    html = html.replace(/`([^`]+)`/g, '<code class="bg-gray-100 text-red-600 px-2 py-1 rounded text-sm font-mono">$1</code>');
    
    // Convert lists
    html = html.replace(/^\s*[-*+]\s+(.+)$/gm, '<li class="ml-6 mb-1">• $1</li>');
    html = html.replace(/^\s*(\d+)\.\s+(.+)$/gm, '<li class="ml-6 mb-1">$1. $2</li>');
    html = html.replace(/((<li[^>]*>.*?<\/li>\s*)+)/g, '<ul class="my-4">$1</ul>');
    
    // Convert paragraphs
    html = html.replace(/\n\n+/g, '</p><p class="mb-4">');
    html = html.replace(/\n/g, '<br>');
    html = '<p class="mb-4">' + html + '</p>';
    html = html.replace(/<p[^>]*><\/p>/g, '');
    
    content.innerHTML = html;
});
</script>
{% endblock %}